services:
  db:
    image: postgres:16-alpine
    container_name: docker-archiver-db
    environment:
      TZ: ${TZ:-Europe/Berlin}
      POSTGRES_DB: docker_archiver
      POSTGRES_USER: archiver
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme123}
    # Use a host bind mount for Postgres data so it's easy to inspect/backup locally
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U archiver -d docker_archiver"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - archiver-net

  redis:
    image: "redis:7-alpine"
    restart: unless-stopped
    volumes:
      - ./redis-data:/data
    networks:
      - archiver-net

  app:
    build: .
    container_name: docker-archiver-app
    environment:
      TZ: ${TZ:-Europe/Berlin}
      DATABASE_URL: postgresql://archiver:${DB_PASSWORD:-changeme123}@db:5432/docker_archiver
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      FLASK_ENV: production
      # Redis for cross-worker SSE
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      # SMTP/Email Configuration (optional)
      SMTP_SERVER: ${SMTP_SERVER:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      # Gunicorn (optional) - commented example overrides
      # If you want to control Gunicorn sizing explicitly, uncomment and set below:
      # GUNICORN_WORKERS: "" # set explicit number of workers (overrides auto sizing)
      # GUNICORN_MAX_WORKERS: "8" # max workers when using automatic sizing (default 8)
      # GUNICORN_THREADS: "2" # threads per worker (default 2)
      # GUNICORN_TIMEOUT: "300" # worker timeout in seconds (default 300)
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Archive output directory (bind mount - adjust to your setup)
      - ./archives:/archives
      # Job logs (detached subprocess stdout/stderr) - optional host bind mount
      # Map a host folder into the container so job logs persist outside the container
      - ./job-logs:/var/log/archiver
      # Stack directories - automatically detected from volume mounts
      # Add bind mounts for your stack directories here
      # The container will automatically scan these for Docker Compose files
      # Examples for different setups:
      # - /opt/stacks:/opt/stacks                    # Default location
      # - /srv/docker/stacks:/srv/docker/stacks      # Systemd/docker-compose location
      # - /home/user/docker:/home/user/docker        # User home directory
      #
      # Add your stack directory mounts here:
      - /opt/stacks:/opt/stacks
      - /home/user/docker:/home/user/docker
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - archiver-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  archiver-net:
    driver: bridge
