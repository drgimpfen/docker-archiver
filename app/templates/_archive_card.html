<div class="card archive-card h-100">
        <div class="card-body d-flex flex-column h-100">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title mb-0">{{ archive.name }}</h6>
                <span class="badge bg-{{ 'success' if archive.schedule_enabled else 'secondary' }}">
                    {{ 'Scheduled' if archive.schedule_enabled else 'Manual' }}
                </span>
            </div>
            
            <div class="mb-2 meta">
                <div class="stack-badges mb-1">
                    {% set st = archive.stacks | sort %}
                    {% for stack in st[:3] %}
                    <span class="badge" data-color="{{ stack|stack_color }}">{{ stack }}</span>
                    {% endfor %}
                    {% if st|length > 3 %}
                    <span class="badge bg-secondary">+{{ st|length - 3 }}</span>
                    {% endif %}
                </div>
                <small class="text-muted d-block">
                    <i class="bi bi-hdd me-1"></i><span title="Net = archived - reclaimed (job reports)">{{ format_bytes(archive.total_size) }}</span>
                </small>
                {% if archive.schedule_enabled and archive.schedule_cron %}
                <small class="text-muted d-block"><i class="bi bi-clock me-1"></i> <code class="small">{{ archive.schedule_cron }}</code></small>
                {% else %}
                <small class="text-muted d-block" aria-hidden="true">&nbsp;</small>
                {% endif %}
            </div>

            <div class="mb-2 last-run">
                {% if archive.last_run %}
                <small class="text-muted">Last run:</small><br>
                <small>
                    <span class="badge bg-{{ 'success' if archive.last_status == 'success' else 'danger' }}">
                        {{ archive.last_status }}
                    </span>
                    {{ archive.last_run|datetime('%Y-%m-%d %H:%M') }}
                </small>
                {% else %}
                <small class="text-muted" aria-hidden="true">&nbsp;</small>
                {% endif %}
            </div>

            <div class="mb-2 retention">
                <small class="text-muted">Retention:</small>
                <small>
                    {{ archive.retention_keep_days or 0 }}/{{ archive.retention_keep_weeks or 0 }}/{{ archive.retention_keep_months or 0 }}/{{ archive.retention_keep_years or 0 }}
                    {% if archive.retention_one_per_day %}
                    <i class="bi bi-calendar-check text-info" title="One per day"></i>
                    {% endif %}
                </small>
            </div>

            <div class="mb-2 next-run">
                <small class="text-muted">Next run:</small><br>
                {% if archive.next_run %}
                <small data-next-run="{{ archive.next_run|iso_z }}">
                    {{ archive.next_run|datetime('%Y-%m-%d %H:%M') }}
                    <span class="text-info">(<span class="time-until"></span>)</span>
                    {% if archive.is_overdue and archive.missed_run %}
                        <span class="text-danger"> (missed {{ archive.missed_run|datetime('%Y-%m-%d %H:%M') }})</span>
                    {% elif archive.is_overdue %}
                        <span class="text-danger"> (overdue)</span>
                    {% endif %}
                </small>
                {% else %}
                <small class="text-muted" aria-hidden="true">&nbsp;</small>
                {% endif %}
            </div>

            <div class="actions mt-auto d-flex flex-column gap-2">
                <div class="d-flex gap-2">
                    <div class="flex-fill">
                        <form method="POST" action="{{ url_for('archives.run', archive_id=archive.id) }}" class="d-block">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-success btn-sm w-100 start-archive-btn" data-archive-id="{{ archive.id }}" data-archive-name="{{ archive.name }}">
                                <i class="bi bi-play-fill me-1"></i>Run Now
                            </button>
                        </form>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#dryRunModal{{ archive.id }}"
                            title="Dry Run">
                        <i class="bi bi-eye me-1"></i>Preview
                    </button>
                </div>
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('archives.run_retention_only', archive_id=archive.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-outline-warning btn-sm w-100" 
                                onclick="return confirm({{ ('Run retention cleanup for ' ~ archive.name ~ '? This will delete old archives according to retention rules.') | tojson }})">
                            <i class="bi bi-trash me-1"></i>Run Retention
                        </button>
                    </form>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" title="Edit Archive" onclick="editArchive({{ archive.id }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" title="Delete Archive" onclick='openDeleteModal({{ archive.id }}, {{ archive.name|tojson }})'>
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Dry Run Modal -->
<div class="modal fade" id="dryRunModal{{ archive.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dry Run: {{ archive.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('archives.dry_run', archive_id=archive.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="text-muted">Select which operations to simulate:</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dry_stop_containers" id="dry_stop{{ archive.id }}" checked>
                        <label class="form-check-label" for="dry_stop{{ archive.id }}">Stop Containers</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dry_create_archive" id="dry_archive{{ archive.id }}" checked>
                        <label class="form-check-label" for="dry_archive{{ archive.id }}">Create Archive</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="dry_run_retention" id="dry_retention{{ archive.id }}" checked>
                        <label class="form-check-label" for="dry_retention{{ archive.id }}">Run Retention</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Dry Run</button>
                </div>
            </form>
        </div>
    </div>
</div>