{% extends "base.html" %}

{% block title %}History - Docker Archiver{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history me-2"></i> Job History</h2>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="archiveFilter" class="form-label">Archive</label>
                <select class="form-select" id="archiveFilter" name="archive_id" onchange="this.form.submit()">
                    <option value="">All Archives</option>
                    {% for archive in archives %}
                    <option value="{{ archive.id }}" {% if request.args.get('archive_id') == archive.id|string %}selected{% endif %}>
                        {{ archive.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="typeFilter" class="form-label">Type</label>
                <select class="form-select" id="typeFilter" name="type" onchange="this.form.submit()">
                    <option value="">All Types</option>
                    <option value="archive" {% if request.args.get('type') == 'archive' %}selected{% endif %}>Archive</option>
                    <option value="retention" {% if request.args.get('type') == 'retention' %}selected{% endif %}>Retention</option>
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <a href="{{ url_for('history.list_history') }}" class="btn btn-outline-secondary">Clear Filters</a>
            </div>
        </form>
    </div>
</div>

{% if jobs %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th style="width: 110px; white-space: nowrap;">Type</th>
                <th style="width: 130px;">Archive</th>
                <th>Stacks</th>
                <th style="width: 80px;">Status</th>
                <th style="width: 120px;">Start</th>
                <th style="width: 120px;">End</th>
                <th style="width: 90px; text-align: right;">Size</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr onclick="showJobDetails({{ job.id }})" style="cursor: pointer;" class="{% if job.is_dry_run %}table-secondary{% endif %}">
                <td><strong>#{{ job.id }}</strong></td>
                <td style="white-space: nowrap;">
                    {% if job.job_type == 'archive' %}
                    <i class="bi bi-box-seam text-primary"></i> Archive
                    {% elif job.job_type == 'retention' %}
                    <i class="bi bi-trash text-warning"></i> Retention
                    {% elif job.job_type == 'cleanup' %}
                    <i class="bi bi-recycle text-info"></i> Cleanup
                    {% else %}
                    <i class="bi bi-question-circle text-muted"></i> {{ job.job_type|title }}
                    {% endif %}
                    {% if job.is_dry_run %}
                    <span class="badge bg-secondary ms-1">DRY</span>
                    {% endif %}
                </td>
                <td>
                    {{ job.archive_name or 'N/A' }}
                </td>
                <td>
                    {% if job.stack_names %}
                        {% set stacks = job.stack_names.split(',') if job.stack_names else [] %}
                        {% for stack in stacks[:3] %}
                            <span class="badge" style="background-color: {{ stack|stack_color }}; color: white;">{{ stack }}</span>
                        {% endfor %}
                        {% if stacks|length > 3 %}
                            <span class="badge bg-secondary">+{{ stacks|length - 3 }}</span>
                        {% endif %}
                    {% elif job.archive_stacks %}
                        {% for stack in job.archive_stacks[:3] %}
                            <span class="badge" style="background-color: {{ stack|stack_color }}; color: white;">{{ stack }}</span>
                        {% endfor %}
                        {% if job.archive_stacks|length > 3 %}
                            <span class="badge bg-secondary">+{{ job.archive_stacks|length - 3 }}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted small">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if job.status == 'success' %}bg-success{% elif job.status == 'running' %}bg-info{% elif job.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ job.status }}
                    </span>
                </td>
                <td>
                    <small style="white-space: nowrap;">{{ job.start_time|datetime }}</small>
                </td>
                <td>
                    <small style="white-space: nowrap;">{{ job.end_time|datetime }}</small>
                </td>
                <td style="text-align: right;">
                    {% if job.job_type == 'archive' and job.total_size_bytes %}
                    <span class="text-success">+{{ format_bytes(job.total_size_bytes) }}</span>
                    {% elif (job.job_type == 'retention' or job.job_type == 'cleanup') and (job.reclaimed_bytes or job.reclaimed_size_bytes) %}
                    <span class="text-warning">-{{ format_bytes(job.reclaimed_size_bytes or job.reclaimed_bytes) }}</span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i> No jobs found matching the filters.
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// showJobDetails and formatBytes functions are now in base.html

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function requestDownload(jobId, stackName, archivePath) {
    try {
        const response = await fetch(`/api/jobs/${jobId}/download`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stack_name: stackName,
                archive_path: archivePath
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.is_folder) {
                // Show notification that archive is being prepared
                alert(data.message);
            } else {
                // Open download link
                window.open(data.download_url, '_blank');
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error requesting download: ' + error.message);
    }
}

function downloadLog(jobId) {
    window.open(`/api/jobs/${jobId}/log`, '_blank');
}
</script>
{% endblock %}

