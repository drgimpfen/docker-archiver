{% extends "base.html" %}

{% block title %}History - Docker Archiver{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history me-2"></i> Job History</h2>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="archiveFilter" class="form-label">Archive</label>
                <select class="form-select" id="archiveFilter" name="archive_id" onchange="this.form.submit()">
                    <option value="">All Archives</option>
                    {% for archive in archives %}
                    <option value="{{ archive.id }}" {% if request.args.get('archive_id') == archive.id|string %}selected{% endif %}>
                        {{ archive.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="typeFilter" class="form-label">Type</label>
                <select class="form-select" id="typeFilter" name="type" onchange="this.form.submit()">
                    <option value="">All Types</option>
                    <option value="archive" {% if request.args.get('type') == 'archive' %}selected{% endif %}>Archive</option>
                    <option value="retention" {% if request.args.get('type') == 'retention' %}selected{% endif %}>Retention</option>
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <a href="{{ url_for('history.list_history') }}" class="btn btn-outline-secondary">Clear Filters</a>
            </div>
        </form>
    </div>
</div>

{% if jobs %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th style="width: 80px;">Status</th>
                <th style="width: 110px; white-space: nowrap;">Type</th>
                <th style="width: 130px;">Archive</th>
                <th>Stacks</th>
                <th style="width: 120px;">Start</th>
                <th style="width: 120px;">End</th>
                <th style="width: 90px;">Duration</th>
                <th style="width: 90px; text-align: right;">Size</th>
                <th style="width: 100px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr data-job-id="{{ job.id }}" style="cursor: pointer;" class="{% if job.is_dry_run %}table-secondary{% endif %}" onclick="(function(e){ (e||window.event||{}).stopPropagation && (e||window.event).stopPropagation(); try { if (typeof showJobDetails === 'function') showJobDetails({{ job.id }}); } catch(err){ console.error(err); } })(event)">
                <td><strong>#{{ job.id }}</strong></td>
                <td>
                    <span class="badge {% if job.status == 'success' %}bg-success{% elif job.status == 'running' %}bg-info{% elif job.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ job.status }}
                    </span>
                </td>
                <td style="white-space: nowrap;">
                    {% if job.job_type == 'archive' %}
                        {% set fmt = job.archive_output_format or 'tar' %}
                        {% if fmt == 'folder' %}
                            <i class="bi bi-folder me-1 text-primary"></i> <span title="folder (for borg backup)">folder</span>
                        {% elif fmt == 'tar' %}
                            <i class="bi bi-archive me-1 text-secondary"></i> <span title="tar (no compression)">tar</span>
                        {% elif fmt == 'tar.gz' %}
                            <i class="bi bi-archive me-1 text-info"></i> <span title="tar.gz (gzip)">tgz</span>
                        {% elif fmt == 'tar.zst' %}
                            <i class="bi bi-archive me-1 text-success"></i> <span title="tar.zst (zstd)">zst</span>
                        {% else %}
                            <i class="bi bi-file-earmark me-1 text-muted"></i> <span title="{{ fmt }}">{{ fmt if fmt|length <= 8 else fmt[:8] + '…' }}</span>
                        {% endif %}
                    {% elif job.job_type == 'retention' %}
                    <i class="bi bi-trash text-warning"></i> <span title="Retention">ret</span>
                    {% elif job.job_type == 'cleanup' %}
                    <i class="bi bi-recycle text-info"></i> <span title="Cleanup">clean</span>
                    {% else %}
                    <i class="bi bi-question-circle text-muted"></i> <span title="{{ job.job_type|title }}">{{ job.job_type|replace('_',' ')|truncate(6) }}</span>
                    {% endif %}
                    {% if job.is_dry_run %}
                    <span class="badge bg-secondary ms-1">DRY</span>
                    {% endif %}
                </td>
                <td>
                    {{ job.archive_name or 'N/A' }}
                </td>
                <td>
                    {% if job.stack_names %}
                        {% set stacks = (job.stack_names.split(',') if job.stack_names else []) | sort %}
                        {% for stack in stacks[:3] %}
                            <span class="badge" data-color="{{ stack|stack_color }}">{{ stack }}</span>
                        {% endfor %}
                        {% if stacks|length > 3 %}
                            <span class="badge bg-secondary">+{{ stacks|length - 3 }}</span>
                        {% endif %}
                    {% elif job.archive_stacks %}
                        {% set stacks2 = job.archive_stacks | sort %}
                        {% for stack in stacks2[:3] %}
                            <span class="badge" data-color="{{ stack|stack_color }}">{{ stack }}</span>
                        {% endfor %}
                        {% if stacks2|length > 3 %}
                            <span class="badge bg-secondary">+{{ stacks2|length - 3 }}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted small">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <small style="white-space: nowrap;">{{ job.start_time|datetime }}</small>
                </td>
                <td>
                    <small style="white-space: nowrap;">{{ job.end_time|datetime }}</small>
                </td>
                <td>
                    <small>{{ format_duration(job.duration_seconds) }}</small>
                </td>
                <td style="text-align: right;">
                    {% if job.job_type == 'archive' and job.total_size_bytes %}
                    <span class="text-success">+{{ format_bytes(job.total_size_bytes) }}</span>
                    {% elif (job.job_type == 'retention' or job.job_type == 'cleanup') and (job.reclaimed_bytes or job.reclaimed_size_bytes) %}
                    <span class="text-warning">-{{ format_bytes(job.reclaimed_size_bytes or job.reclaimed_bytes) }}</span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if job.job_type == 'archive' and job.status == 'success' %}
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showDownloadModal({{ job.id }}, '{{ job.archive_name }}')" title="Download stacks">
                            <i class="bi bi-download"></i>
                        </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i> No jobs found matching the filters.
</div>
{% endif %}

<!-- Download Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="downloadModalLabel">Download Stacks - <span id="downloadArchiveName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="downloadContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// showJobDetails and formatBytes functions are now in base.html

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function showDownloadModal(jobId, archiveName) {
    document.getElementById('downloadArchiveName').textContent = archiveName;
    
    const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
    modal.show();
    
    // Load job details to get stack metrics
    try {
        const response = await fetch(`/api/jobs/${jobId}`);
        const data = await response.json();
        
        if (data.job && data.metrics) {
            let html = '<div class="list-group">';
            
            data.metrics.forEach(metric => {
                if (metric.archive_path && !metric.deleted_at) {
                    const stackName = metric.stack_name;
                    const archivePath = metric.archive_path;
                    const fileSize = metric.archive_size_bytes ? formatBytes(metric.archive_size_bytes) : 'Unknown';
                    
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${stackName}</strong>
                                <br><small class="text-muted">${fileSize} • ${archivePath.split('/').pop()}</small>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="requestDownload(${jobId}, '${stackName}', '${archivePath}')">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            if (html === '<div class="list-group"></div>') {
                html = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No downloadable archives found for this job.</div>';
            }
            
            document.getElementById('downloadContent').innerHTML = html;
        } else {
            document.getElementById('downloadContent').innerHTML = '<div class="alert alert-danger">Error loading job details.</div>';
        }
    } catch (error) {
        document.getElementById('downloadContent').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

async function requestDownload(jobId, stackName, archivePath) {
    try {
        const response = await fetch('/api/downloads/request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stack_name: stackName,
                archive_path: archivePath
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.is_folder) {
                // Close download modal and show preparation message
                const downloadModal = bootstrap.Modal.getInstance(document.getElementById('downloadModal'));
                downloadModal.hide();
                
                // Show preparation modal
                const prepModal = new bootstrap.Modal(document.getElementById('downloadPrepModal'));
                const msgEl = document.getElementById('downloadPrepMessage');
                if (msgEl) msgEl.textContent = data.message || 'The archive is being prepared; you will receive a notification when it is ready.';
                prepModal.show();
            } else {
                // Close modal and open download link
                const modal = bootstrap.Modal.getInstance(document.getElementById('downloadModal'));
                modal.hide();
                window.open(data.download_url, '_blank');
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error requesting download: ' + error.message);
    }
}

function downloadLog(jobId) {
    window.open(`/api/jobs/${jobId}/log`, '_blank');
}
</script>
{% endblock %}

