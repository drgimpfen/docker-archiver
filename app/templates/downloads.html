{% extends "base.html" %}

{% block title %}Downloads - Docker Archiver{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-4">
        <h2><i class="bi bi-download me-2"></i> Downloads</h2>
        <p class="text-muted">Manage active download tokens and trigger cleanup of expired downloads.</p>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-key me-2"></i> Active Download Tokens</h5>
        </div>
        <div class="card-body">
            <div id="tokensTable">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">Back</a>
        <button type="button" class="btn btn-secondary" onclick="cleanupTokens()">
            <i class="bi bi-trash me-1"></i> Cleanup Expired Tokens
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadTokens() {
    try {
        const response = await fetch('/api/downloads/tokens');
        const data = await response.json();
        
        if (data.tokens && data.tokens.length > 0) {
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Stack Name</th>
                                <th>File</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Status</th>
                                <th>Notify</th>
                                <th>Token</th>
                                <th style="width:140px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.tokens.forEach(token => {
                const statusBadge = token.is_packing 
                    ? '<span class="badge bg-warning">Packing</span>' 
                    : '<span class="badge bg-success">Ready</span>';
                const notify = (token.notify_emails && token.notify_emails.length > 0) ? `<small>${token.notify_emails.join(', ')}</small>` : '<span class="text-muted">-</span>';
                const fileName = token.file_name ? token.file_name : '<span class="text-muted">-</span>';

                html += `
                    <tr>
                        <td>${token.stack_name}</td>
                        <td>${fileName}</td>
                        <td>${token.created_at ? new Date(token.created_at).toLocaleString() : 'N/A'}</td>
                        <td>${token.expires_at ? new Date(token.expires_at).toLocaleString() : 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>${notify}</td>
                        <td><code>${token.token}</code></td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="showSendDownloadModal(null, null, '${token.token}')" title="Send to email"><i class="bi bi-envelope"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteToken('${token.token}')" title="Delete Token"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('tokensTable').innerHTML = html;
        } else {
            document.getElementById('tokensTable').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i> No active download tokens found.
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('tokensTable').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i> Error loading tokens: ${error.message}
            </div>
        `;
    }
}

async function cleanupTokens() {
    if (!confirm('Are you sure you want to cleanup expired tokens? This will delete expired tokens and their associated files.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/downloads/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Cleanup completed successfully');
            loadTokens();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load tokens on page load
document.addEventListener('DOMContentLoaded', loadTokens);

async function deleteToken(token) {
    if (!confirm('Delete token ' + token + '?')) return;
    try {
        const resp = await fetch('/api/downloads/tokens/' + encodeURIComponent(token), { method: 'DELETE' });
        if (!resp.ok) {
            const d = await resp.json();
            alert('Delete failed: ' + (d.error || resp.status));
            return;
        }
        alert('Token deleted');
        loadTokens();
    } catch (e) {
        alert('Delete failed: ' + e.message);
    }
}
</script>
{% endblock %}