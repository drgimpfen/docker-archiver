# Notify a Discord channel when a release is published or when manually dispatched.
# Triggers:
#  - release: published
#  - workflow_dispatch (requires input `release_tag`)
# Required repository secrets:
#  - DISCORD_WEBHOOK_URL: webhook URL for the target Discord channel

name: Notify Discord on Release

permissions:
  contents: read

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag name of the release (e.g. v1.2.3)'
        required: true
        default: ''

jobs:
  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Determine release information
        id: get_release
        shell: bash
        run: |
          set -euo pipefail

          # Use the event JSON file written by GitHub Actions to extract release information
          TAG=""
          TITLE=""
          RELEASE_URL=""
          BODY=""

          if [ "${GITHUB_EVENT_NAME:-}" = "release" ]; then
            TAG=$(python - <<'PY'
import json, os
try:
    e = json.load(open(os.environ['GITHUB_EVENT_PATH']))
    print(e.get('release', {}).get('tag_name', ''))
except Exception:
    print('')
PY
)
            TITLE=$(python - <<'PY'
import json, os
try:
    e = json.load(open(os.environ['GITHUB_EVENT_PATH']))
    print(e.get('release', {}).get('name', '') or '')
except Exception:
    print('')
PY
)
            RELEASE_URL=$(python - <<'PY'
import json, os
try:
    e = json.load(open(os.environ['GITHUB_EVENT_PATH']))
    print(e.get('release', {}).get('html_url', '') or '')
except Exception:
    print('')
PY
)
            BODY=$(python - <<'PY'
import json, os
try:
    e = json.load(open(os.environ['GITHUB_EVENT_PATH']))
    print(e.get('release', {}).get('body', '') or '')
except Exception:
    print('')
PY
)
          else
            # workflow_dispatch stores inputs in the event JSON under 'inputs'
            TAG=$(python - <<'PY'
import json, os
try:
    e = json.load(open(os.environ['GITHUB_EVENT_PATH']))
    print(e.get('inputs', {}).get('release_tag', '') or '')
except Exception:
    print('')
PY
)

            # If tag is present, try to fetch the release info from the API using GITHUB_TOKEN
            if [ -n "$TAG" ]; then
              RESP=$(curl -sS -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" || true)
              TITLE=$(echo "$RESP" | python - <<'PY'
import sys, json
try:
    d=json.load(sys.stdin)
    print(d.get('name') or d.get('tag_name') or '')
except Exception:
    print('')
PY
)
              RELEASE_URL=$(echo "$RESP" | python - <<'PY'
import sys, json
try:
    d=json.load(sys.stdin)
    print(d.get('html_url') or '')
except Exception:
    print('')
PY
)
              BODY=$(echo "$RESP" | python - <<'PY'
import sys, json
try:
    d=json.load(sys.stdin)
    print(d.get('body') or '')
except Exception:
    print('')
PY
)
            fi
          fi

          # Provide fallbacks
          [ -n "$TITLE" ] || TITLE="$TAG"
          [ -n "$RELEASE_URL" ] || RELEASE_URL="https://github.com/${REPO}/releases/tag/${TAG}"

          # Write safe multiline values to GITHUB_ENV
          echo "release_tag=$TAG" >> "$GITHUB_ENV"
          echo "release_title=$TITLE" >> "$GITHUB_ENV"
          echo "release_url=$RELEASE_URL" >> "$GITHUB_ENV"
          echo "release_body<<'EOF'" >> "$GITHUB_ENV"
          printf '%s
' "$BODY" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL secret is not set. Aborting."
            exit 1
          fi

          JSON_PAYLOAD=$(python - <<'PY'
import os, json, datetime

title = os.environ.get('release_title') or os.environ.get('release_tag')
url = os.environ.get('release_url')
body = os.environ.get('release_body') or ''
# Truncate body to Discord embed description limit (approx 2048)
if len(body) > 2048:
    body = body[:2045] + '...'
embed = {
    'title': f'Release {title}',
    'url': url,
    'description': body,
    'timestamp': datetime.datetime.utcnow().isoformat(),
    'color': 3066993
}
print(json.dumps({'embeds': [embed]}))
PY
)

          curl -sS -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK_URL" -o /dev/null
          echo "Posted release $release_tag to Discord."